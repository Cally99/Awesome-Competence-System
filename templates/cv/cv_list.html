{% extends "./cvbase.html" %}
{% load image_tags %}

{% block title %}CV{% endblock %}

{% block actions %}
	<h1>Employee CV</h1>
	<input type="text" name="filter" id="filter" size="20" style="margin:0;" placeholder="Search"/>
	{% if user.is_authenticated %}
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="{% url admin:cv_person_add %}" class="butt"><i class="icon-plus-sign"></i> Add new person</a>
	{% endif %}
{% endblock %}

{% block content %}

	<script>
		$(function() {
			var filterTxt;
			$('#filter').keyup( function(event) {
				filterTxt = $(this).val();
				$.ajax({
					type:"get",
					url: "{% url ajax_search %}",
					data: {'q':filterTxt},
					cache: false
				}).done(function( html ) {
					$("#results").html(html);
				});

				/*$('.block').addClass('hidden');
				$('.tags')
					.filter( function(index) {
						return $(this).text().toLowerCase().indexOf(filterTxt.toLowerCase()) >= 0;
					})
					.parent().parent().removeClass('hidden');
				*/
			});
		});
	</script>
	<div id="results">
	{% if all_persons %}
		{% for p in all_persons|dictsort:"name" %}
			<div class="block tiled">
			
				<header>
					<h3>{{ p.name }}</h3>
					<h4>{% if p.title %}{{ p.title }}{% else %} ---{% endif %}</h4>
				</header>
				{% if p.image %}
					<img src="{{ p.image|scale:"110x110" }}" class="photo" style="float: left;">
				{% endif %}
				<div class="completeness">
					<div class="percent{% if p.completeness.percent < 100 %} redpercent{% endif %}" style="width: {{ p.completeness.percent }}%;"></div>
				</div>
				<section>
					<p class="ldetail">{{ p.phone }}<br/>
					{{ p.mail }}</p>
				</section>

				<div class="cvset">
					{% if user.is_authenticated %}
						<p class="ldetail">
							Profile {{ p.completeness.percent }}% complete. Updated: {{ p.last_edited|date:"SHORT_DATE_FORMAT" }}
						</p>
						{% if p.completeness.comment %}<ul class="ldetail">{{ p.completeness.comment|unordered_list }}</ul>{% endif %}
						<a href="{% url admin:cv_person_change p.id %}" class="butt">Edit person</a>
					{% endif %}
					<table>
					{% for cv in p.cv_set.all|dictsortreversed:"cvsort" %}
						{% if user.is_anonymous and cv.tags == "Empty CV" or p.completeness.percent < 10 %}
						{% else %}
						<tr>
							<td><a href="{% url cv_detail cv.id %}" class="butt bigbutt{% if cv.tags = "Empty CV" %} empty{% elif not cv.is_recent or not cv.status.complete %} red{% endif %}" title="{{ cv.status.comment }}">{{ cv.tags }}<br/>
							<span class="dato">{% if cv.tags != "Empty CV" %}{{ cv.last_edited|date:"SHORT_DATE_FORMAT" }} <span class="completeness"><span class="percent{% if cv.status.percent < 100 %} redpercent{% endif %}" style="width: {{ cv.status.percent }}%;"></span></span> {{ cv.status.percent }}%{% else %}&nbsp;{% endif %}</span></a></td>
							{% if user.is_authenticated %}
								<td><a href="{% url admin:cv_cv_change cv.id %}" class="butt">Edit<br/>
								<span class="dato">CV</span></a></td>
							{% endif %}
						</tr>
						{% endif %}
					{% endfor %}
					</table>
				</div>
				
			</div>
		{% endfor %}

	{% else %}
		<div class="block">
			<p>Her er det ingen CVer, dessverre!</p>
		</div>
	{% endif %}
	</div>

	<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>

{% endblock %}