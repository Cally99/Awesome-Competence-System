{% extends "./cvbase.html" %}
{% load image_tags %}

{% block title %}CV{% endblock %}

{% block extrastyles %}
		<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/nouislider.fox.css"/>
{% endblock %}

{% block actions %}
	<h1>ACS Persons</h1>
	<input type="text" name="filter" id="filter" size="30" style="margin:0;" placeholder="Search" autofocus/>
	{% if user.is_authenticated %}
		<div>
			<a href="{% url admin:cv_person_add %}" class="butt"><i class="icon-plus-sign"></i> Add new person</a><br/>
		</div>
	{% endif %}
	<div id="facets">
		<div id="expslider" class="noUiSlider"></div>
	</div>
{% endblock %}

{% block content %}
	<label><input type="checkbox" id="multicvcheck" onChange="cvlist.toggleMulti(this);">Download multiple CVs</label>
	<form name="multicv" action="{% url cv_multi %}" method="get">
		<div id="multicontrols" style="display:none;">
			Format:&nbsp;<select name="format" id="format">
				<option value="doc">Microsoft Word (.doc)</option>
				<option value="pdf">Adobe Reader (.pdf)</option>
				<option value="odt">OpenDocument Text (.odt)</option>
			</select>
			<a href="" onClick="cvlist.downloadMulti(); return false;" class="butt"><i class="icon-copy"></i> Download selected CVs</a>
		</div>
		<div id="numfound"></div>
		<div id="results"></div>
	</form>

	<script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}js/doT.min.js"></script>

	<script id="persontemplate" type="text/x-dot-template">
		<div class="block tiled" id="p<%=p.id%>">
			<header>
				<h3><%=p.name%><%? p.country %> <img src="{{ STATIC_URL }}img/flags/<%=p.country%>.gif" width="16" height="11" alt="<%=p.country%>"/><%?%></h3>
				<h4><%=p.title%></h4>
			</header>
			<%?p.image%><img src="/media/<%=p.image%>" class="photo" style="float: left;"><%?%>

			<div class="completeness">
				<div class="percent<%? p.completeness.percent < 100 %> redpercent<%?%>" style="width: <%=p.completeness.percent%>%;"></div>
			</div>
			<section><p class="ldetail"><%=p.phone%><br/><%=p.mail%></p></section>
			<div class="cvset">
				{% if user.is_authenticated %}
					<p class="ldetail">Profile <%=p.completeness.percent%>% complete. Updated: <%=p.last_edited%></p>
					<%? p.completeness.comment %><ul class="ldetail"><%~p.completeness.comment :value:index%><li><%=value%></li><%~%></ul><%?%>
					<a href="{% url admin:cv_person_change "XXXpidXXX" %}" class="butt">Edit person</a>
				{% endif %}
				<table>
				<%~p.cv :cv:index%>
					<%? p.completeness.percent > 10 {% if user.is_anonymous %}&& cv.tags != "Empty CV"{% endif %} %> 
					<tr>
						<td>
							<a href="{% url cv_detail "999999" %}" class="butt bigbutt<%? cv.tags == "Empty CV" %> empty<%?? !cv.is_recent || !cv.status.complete %> red<%?%>" title="<%=cv.status.comment%>"><%=cv.tags%><br/>
							<span class="dato"><%? cv.tags != "Empty CV" %><%=cv.last_edited%>
								<span class="completeness"><span class="percent<%? cv.status.percent < 100 %> redpercent<%?%>" style="width: <%=cv.status.percent%>%;"></span></span>
							 <%=cv.status.percent%>%<%??%>&nbsp;<%?%></span></a>
						</td>
						{% if user.is_authenticated %}
							<td><a href="{% url admin:cv_cv_change "XXXcvidXXX" %}" class="butt">Edit<br/>
							<span class="dato">CV</span></a></td>
						{% endif %}
					</tr>
					<%?%>
				<%~%>
				</table>
			</div>
		</div>
	</script> 

	<style> 
		.multiline {text-align: left; background: #fff; padding:.5em; margin:.2em;}
		.multileft {display: inline-block; width: 300px;}
		.multiright {display: inline-block; vertical-align: top;}
	</style>

	<script id="multitemplate" type="text/x-dot-template">
		<div class="multiline" id="p<%=p.id%>">
			<div class="multileft">
				<%?p.image%><img src="/media/<%=p.image%>" class="" style="float: left;max-width:32px;max-height:32px;"><%?%>
				<h3><%=p.name%><%? p.country %> <img src="{{ STATIC_URL }}img/flags/<%=p.country%>.gif" width="16" height="11" alt="<%=p.country%>"/><%?%></h3>
				<h4><%=p.title%></h4>
				<p class="ldetail">Profile <%=p.completeness.percent%>% complete. Updated: <%=p.last_edited%></p>
			</div>

			<div class="multiright">
				<%~p.cv :cv:index%>
					<%? cv.tags != "Empty CV" %>
						<%? p.completeness.percent > 10 {% if user.is_anonymous %}&& cv.tags != "Empty CV"{% endif %} %> 
						<div>
							<input type="checkbox" name="cvid" value="<%=cv.id%>" id="<%=cv.id%>">
							<label for="<%=cv.id%>">
								<%=cv.tags%> <%=cv.last_edited%> <%=cv.status.percent%>% <a href="{% url cv_detail "999999" %}" class="butt" title="<%=cv.status.comment%>" target="_blank">View</a>&nbsp;
								Download:&nbsp;
								<a href="{% url cv_download_format 'doc' %}?cvid=<%=cv.id%>" class="butt" target="_blank">Word (.doc)</a>&nbsp;
								<a href="{% url cv_download_format 'pdf' %}?cvid=<%=cv.id%>" class="butt" target="_blank">Adobe Reader (.pdf)</a>&nbsp;
								<a href="{% url cv_download_format 'odt' %}?cvid=<%=cv.id%>" class="butt" target="_blank">OpenOffice (.odt)</a>&nbsp;
							</label>
						</div>
						<%?%>
					<%?%>
				<%~%>
			</div>
		</div>
	</script> 

	<script id="facettemplate" type="text/x-dot-template">
		<label><input type="checkbox" name="<%=p.name%>" onChange="cvlist.toggleFacet('<%=p.name%>','<%=p.facet%>',this);"/><%=p.name%></label><br/>
	</script>

	<script src="{{ STATIC_URL }}js/jquery.nouislider.min.js"></script>
	<script>

		var cvlist = {

			facetTemplate: $('#facettemplate').text(),
			facetRenderer: '',
			
			personStandardTemplate: $('#persontemplate').text().replace('XXXcvidXXX','<%=cv.id%>').replace('XXXpidXXX','<%=p.id%>').replace('999999','<%=cv.id%>'),
			personStandardRenderer: '',

			personMultiTemplate: $('#multitemplate').text().replace('XXXcvidXXX','<%=cv.id%>').replace('XXXpidXXX','<%=p.id%>').replace('999999','<%=cv.id%>'),
			personMultiRenderer: '',
			
			multi: false,
			toggleMulti: function(t) {
				var self = this;
				self.multi = t.checked;
				if(!t.checked){
					$('#multicontrols').hide();
				} else {
					$('#multicontrols').show();
				}
				self.renderResults(self.bufferedData);
			},
			downloadMulti: function() {
				if(this.multi){
					document.forms['multicv'].submit();
				} else {
					alert('No soup for you.');
				}
			},

			personRenderer: function(data) {
				if(!this.multi){
					return this.personStandardRenderer(data);
				} else {
					return this.personMultiRenderer(data);
				}
			},
			
			renderResults: function(data) {
				var html = "";
				var self = this;
				data = jQuery.parseJSON( data );
				if(data.response.numFound > 0){
					this.updateNumfound(data.response.numFound);
					var ppl = data.response.docs;
					for(i=0;i<ppl.length;i++) {
						var person = jQuery.parseJSON( data.response.docs[i].rendered );
						person.image = person.image.replace(/(.jpg|.png)/gi,'_scale_110x110.jpg');
						html += this.personRenderer(person);
					}
				} else {
					this.updateNumfound('');
					html = "No people found for search " + data.responseHeader.params.q;
				}
				self.displayResults(html);
				self.showHighlights(data.highlighting);
			},

			displayResults: function(text) {
				$("#results").html(text);
			},

			updateNumfound: function(num){
				text = num > 0 ? " matches" : "";
				document.getElementById('numfound').innerHTML = num + text;
			},

			showFacets: function(facets){
				var facethtml = "";
				for( var facet in facets ){
					var content = "";
					if(facet == 'years_of_experience_exact') {
						var maxValue = 0;
						var curValue = 0;
						for (var j=0;j<facets[facet].length;j+=2){
							curValue = parseInt(facets[facet][j]);
							if( curValue > maxValue ) {
								maxValue = curValue;
							}
						}
						$("#expslider").noUiSlider({
						    range: [0, maxValue]
						   ,start: [0, maxValue]
						   ,step: 1
						   ,slide: function(){
						   		console.log($(this).val());
						   }
						});
					} else {
						for (var i=0;i<facets[facet].length;i+=2){
							var facetdata = {
								facet: facet,
								name: facets[facet][i],
								count: facets[facet][i+1]
							}
							content += this.facetRenderer(facetdata);
						}
						facethtml += '<div class="facetfilter"><h3>'+facet.replace('_exact','')+'</h3>'+content+'</div>';
					}
				}
				$("#facets").append( facethtml );	
			},

			toggleFacet: function(facet,facetname,t){
				// fq:['location:(oslo OR gothenburg)','department:software engineering']
				var facetentry = facetname+":"+facet;
				if(t.checked){
					fq.addFacet(facet, facetname);
				} else {
					fq.removeFacet(facet, facetname);
				}
				this.doSearch();
			},

			showHighlights: function(highlights){
				for( var person in highlights ){
					var pid = person.replace(/cv.person./, 'p');
					for( var highlight in highlights[person] ) {
						$('#'+pid + ' .cvset').prepend('<div class="highlight">...'+highlights[person][highlight]+'...</div>');
					}
				}
			},

			doSearch: function(){
				var self = this,
				searchrequest = $.ajax({
					type:"get",
					url: self.solrurl,
					data: self.solrdata,
					traditional: true,
					cache: false
				}).done(function( data ) {
					self.bufferedData = data;
					self.renderResults(data);
				});
			},

			solrurl: "/solr/collection1/select",
		 	solrdata: {
		 		'q':'*',
		 		'wt':'json',
		 		'indent':'true',
		 		'sort':'name_exact asc',
		 		'rows':50,
		 		'hl': 'false',
		 		'facet': 'true',
		 		'facet.field': [
		 			'location_exact', 
		 			'department_exact',
		 			'years_of_experience_exact'
		 			], 
		 		'fq':[]
		 	},
		 	bufferedData: '',
		 	filterTxt: '',
			init: function() {
				var self = this;

				doT.templateSettings = {
				  evaluate:    /\<\%([\s\S]+?)\%\>/g,
				  interpolate: /\<\%=([\s\S]+?)\%\>/g,
				  encode:      /\<\%!([\s\S]+?)\%\>/g,
				  use:         /\<\%#([\s\S]+?)\%\>/g,
				  define:      /\<\%##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\%\>/g,
				  conditional: /\<\%\?(\?)?\s*([\s\S]*?)\s*\%\>/g,
				  iterate:     /\<\%~\s*(?:\%\>|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\%\>)/g,
				  varname: 'p',
				  strip: true,
				  append: true,
				  selfcontained: false
				};

				self.searchrequest = $.ajax({
					type:"get",
					url: self.solrurl,
					data: self.solrdata,
					traditional: true,
					cache: false
				}).done(function( data ) {
					self.bufferedData = data;
					self.renderResults(data);
					data = jQuery.parseJSON( data );
					self.showFacets(data.facet_counts.facet_fields);
				});

				self.personStandardRenderer = doT.template(self.personStandardTemplate);
				self.personMultiRenderer = doT.template(self.personMultiTemplate);
				self.facetRenderer = doT.template(self.facetTemplate);

			}

		};

		cvlist.init();

		$('#filter').keyup( function(event) {
		    if(typeof cvlist.searchrequest !== 'undefined'){
		        cvlist.searchrequest.abort();
		    }
			cvlist.filterTxt = $(this).val();
			if(cvlist.filterTxt != '') {
				cvlist.solrdata.q = cvlist.filterTxt+'*';
				cvlist.solrdata.hl = 'true';
				cvlist.doSearch();
			} else {
				cvlist.solrdata.q = '*';
				cvlist.solrdata.hl = 'false';
				cvlist.doSearch();
			}
		});

		var fq = {
			facets: {},
			addFacet: function(facet, facetname) {
				if(this.facets[facetname] === undefined)
					this.facets[facetname] = [];
				this.facets[facetname].push(facet);
				this.updateFq();
			},
			removeFacet: function(facet, facetname) {
				var i = this.facets[facetname].indexOf(facet);
				if(i >= 0) {
					this.facets[facetname].splice(i, 1);
				}
				this.updateFq();
			},
			updateFq: function(){
				var results = [];
				var result = "";
				for( var f in this.facets ) {
					if( this.facets[f].length > 0 ) {
						result += f + ":(";
						for(i=0;i<this.facets[f].length;i++) {
							result += '"'+this.facets[f][i]+'"';
							if(this.facets[f][+i+1] !== undefined) 
								result+=" OR ";
						}
						result += ")";
					}
					results.push(result);
				}
				cvlist.solrdata.fq = result;
			}
		}

	</script>

{% endblock %}
