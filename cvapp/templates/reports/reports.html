{% extends "./cvbase.html" %}

{% block title %}Reports{% endblock %}

{% block extrastyles %}
<style>
	p {font-size: 80%;} 
	.scorehigh 		{background-color: #cf6;}
	.scoremedium 	{background-color: #fb3;}
	.scorelow 		{background-color: #ccc;}
	table {font-size: 0.8em; position: relative; float: left; width: 45%; background-color: #fff}
	th { font-weight: 700;}
	th, td { border-bottom: 1px solid #eee; padding: .5em; max-width: 500px}
	.sort { text-decoration: underline; cursor: pointer;}
	.sort:hover { background-color: #eee;}
	tbody tr:hover, .selected { background-color: #f3f3f3; cursor: pointer; }
	#persondetails {
		text-align: left;
		background-color: #fff;
		padding: 1em;
		margin-left: 2em;
		float: left;
		width: 45%;
	}
</style>
{% endblock %}

{% block content %}
<h1>Reports</h1>

<form action="" id="searchform">
	<select name="predefined_queries" id="predefined_queries">
		<option value="(technology:java)^4 Java (technology:maven)^2 (develop OR utvikle OR utveckla)^2">Java-developer</option>
		<option value="(technology:java OR technology:.net) OR (c# OR c++) scrum">System developer</option>
		<option value="scrum^2 OR ('project manager' OR projektledare OR prosjektleder)^3 AND (lead OR lede)">Project manager</option>
		<option value="(technology:javascript AND technology:html AND technology:css)^3 frontend^5">Frontend developer</option>
		<option value="(architect OR arkitekt)">Systems architect</option>
	</select>
	<input type="text" name="q" id="q" style="width: 80%">
	<button class="butt" id="searchbtn">Search</button>
</form>

<table id="results">
	<thead>
		<tr>
			<th></th>
			<th class="sort" data-sort="t_name">Name</th>
			<th class="sort" data-sort="t_mail">Mail</th>
			<th class="sort" data-sort="t_match">Match</th>
			<th class="sort" data-sort="t_experience">Experience</th>
		</tr>
	</thead>
	<tbody id="resultsbody" class="list">
	</tbody>
</table>

<div id="persondetails" class="block">
	
</div>

<script id="template" type="text/x-dot-template">
	<%~ppl :p:jindex%>
		<tr id="p<%=p.id%>" data-personindex="<%=jindex%>">
			<td>
				<%? p.country %> <img src="{{ STATIC_URL }}img/flags/<%=p.country%>.gif" width="16" height="11" alt="<%=p.country%>"/><%?%>
				</td>
			<td class="t_name">
				<%=p.name%>
				</td>
			<td class="t_mail">
				<%=p.mail%>
				</td>
			<td class="t_match <%=(p.score>0.7)?'scorehigh':(p.score>0.5)?'scoremedium':'scorelow'%>">
				<%=Math.round( p.score*1000 )/10 %>
				</td>
			<td class="t_experience">
				<%=p.years_of_experience%>
				</td>
		</tr>
	<%~%>
</script> 

<script id="detailtemplate" type="text/x-dot-template">
	<img src="/media/<%=ppl.image.replace(/(\.png|\.jpg|\.gif|\.jpeg)/i,'_scale_110x110.jpg')%>" alt="<%=ppl.name%>" class="photo" style="float:left; position: relative; right:0;top:0; margin-right: 1em;">
	<h3><%=ppl.name%></h3>
	<h4><%=ppl.title%></h4>
	<br>
	<%~ppl.cv :c:index%>
		<h3><%=c.title%></h3>
		<p class="small"><%=c.profile%></p>
		<br>
	<%~%>
</script>

<script type="text/javascript" src="{{ STATIC_URL }}js/doT.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/list.min.js"></script>
<script>

var SOLR = (function($, doT){

 	var ajaxConf = {
		type: 'get',
		url: '/solr/collection1/select',
		data: {
	 		q: '*',
	 		wt: 'json',
	 		indent: 'true',
	 		sort: 'score desc',
	 		rows: 10000,
	 		hl: 'false',
	 		fl: 'fulljson,score,years_of_experience'
	 	},
		traditional: true,
		cache: false
	};
	
	var people = [];

	function callServer(){
		ajaxConf.data.q = $('#q').val();
		$.ajax(ajaxConf).done(function( data ) {
			data = jQuery.parseJSON( data );
			parseResults( data );
			var changelist = new List('results', {
			    valueNames: [ 
			    	't_name',
			    	't_mail', 
			    	't_match', 
			    	't_experience' 
			    	],
			    page: 300
			});
		});
	}

	function parseResults(data){
		$('#persondetails').html('');
		var docs = data.response.docs;
		people = [];
		for( var i = 0; i < docs.length; i++ ) {
			people.push( JSON.parse( docs[i].fulljson.replace(/\s+/g,' ') ) );
			people[i].score = docs[i].score; 
			people[i].years_of_experience = docs[i].years_of_experience;
		}
		console.log('JSON List of People:', people);
		var html = renderer(people);
		$('#resultsbody').html(html);
	}

	function searchFormSubmit(e){
		console.log('Search form sent');
		callServer();
		e.preventDefault();
	}

	function showPersonDetails(){
		$('tr').removeClass('selected');
		var $t = $(this);
		$t.addClass('selected');
		var personindex = $t.data('personindex');
		console.log('Person click - Index: ', personindex);
		$('#persondetails').html( detailrenderer(people[personindex]) );
	}

	function init() {

		doT.templateSettings = {
			evaluate:    /\<\%([\s\S]+?)\%\>/g,
			interpolate: /\<\%=([\s\S]+?)\%\>/g,
			encode:      /\<\%!([\s\S]+?)\%\>/g,
			use:         /\<\%#([\s\S]+?)\%\>/g,
			define:      /\<\%##\s*([\w\.$]+)\s*(\:|=)([\s\S]+?)#\%\>/g,
			conditional: /\<\%\?(\?)?\s*([\s\S]*?)\s*\%\>/g,
			iterate:     /\<\%~\s*(?:\%\>|([\s\S]+?)\s*\:\s*([\w$]+)\s*(?:\:\s*([\w$]+))?\s*\%\>)/g,
			varname: 'ppl',
			strip: true,
			append: true,
			selfcontained: false
		};

		renderer = doT.template( $('#template').text() );
		detailrenderer = doT.template( $('#detailtemplate').text() );

		var $pq = $('#predefined_queries');
		$('#q').val( $pq.val() );
		$pq.change( function(){
			$('#q').val( $(this).val() );
		});
		$('#searchbtn').click(searchFormSubmit);
		$('#searchform').submit(searchFormSubmit);
		$('#resultsbody').on('click','tr',showPersonDetails)
		// Retrieve initial data
		callServer();

	}

	return {
		init: init,
		callServer: callServer
	}

}($, doT));

SOLR.init();

</script>
{% endblock %}