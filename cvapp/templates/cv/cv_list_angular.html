{% extends "./cvbase.html" %}

{% block title %}CV{% endblock %}

{% block extrastyles %}
  <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/themes/smoothness/jquery-ui.css" />
  <script type="text/javascript">
    var DJANGO_URLS = {
      cv_person_change:       "{% url 'admin:cv_person_change' "999999" %}".replace('999999/',''),
      cv_add_cv_for_person:   "{% url 'cv_add_cv_for_person' "999999" %}".replace('999999/',''),
      cv_person_add:          "{% url 'admin:cv_person_add' %}",
      cv_cv_change:           "{% url 'admin:cv_cv_change' "888888" %}".replace('888888/',''),
      cv_download_format_doc: "{% url 'cv_download_format' 'doc' %}",
      cv_download_format_pdf: "{% url 'cv_download_format' 'pdf' %}",
      cv_download_format_odt: "{% url 'cv_download_format' 'odt' %}",
      cv_detail:              "{% url 'cv_detail' "888888" %}".replace('888888/',''),
      cv_multi:               "{% url 'cv_multi' %}",
      media: "{{ MEDIA_URL }}",
      static: "{{ STATIC_URL }}",
      solr: "{{solrurl}}"
    };

    var CV_TEMPLATES = [
      {value: 'default', label: 'Default', checked: true},
      {% for t in templates %}
      {value: '{{t.id}}', label: '{{t.title}}'}{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];
  </script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.11.0/jquery-ui.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-touch.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-animate.min.js"></script>
  <script src="{{ STATIC_URL }}js/doT.min.js"></script>
  <script src="{{ STATIC_URL }}js/ZeroClipboard.min.js"></script>
  <script src="{{ STATIC_URL }}js/flash_detect_min.js"></script>
  <script src="{{ STATIC_URL }}js/cv_list_slider.js"></script>
  <script src="{{ STATIC_URL }}js/cv_list_ctrl.js"></script>
  <script src="{{ STATIC_URL }}js/url_service.js"></script>
  <script src="{{ STATIC_URL }}js/scroller_directive.js?20140813"></script>
  <script src="{{ STATIC_URL }}js/tristatecheckbox_directive.js"></script>
{% endblock %}

{% block actions %}
  
  {% if not user.person %}
    <p style="padding: 1em; margin: 1em; background: #fff; display: inline-block; border-bottom: 2px solid #bbb;">
      Hi, {% if user.first_name %}{{user.first_name}} {{user.last_name}}{% else %}{{user.username}}{% endif %}! You don't seem to have a CV profile. 
      <a href="{% url 'cv_add_person_for_user' %}" class="butt butt-action">Create a profile now!</a>
    </p><br/>
  {% elif not user.person.cv_set.all %}
    <p style="padding: 1em; margin: 1em; background: #fff; display: inline-block; border-bottom: 2px solid #bbb;">
      Hi, {% if user.first_name %}{{user.first_name}} {{user.last_name}}{% else %}{{user.username}}{% endif %}! You have registered a profile, but you don't seem to have any CVs.
      <a href="{% url 'cv_add_cv_for_person' user.person.id %}" class="butt butt-action">Create a CV now!</a>
    </p><br/>
  {% endif %}

  <h1>ACS</h1>
  <input type="text" size="30" style="margin:0 0 1em 0; padding:0.4em" name="searchQuery" placeholder="Search" ng-model="searchQuery" ng-change="updateAndSearchAcs()" autofocus/>
  <div style="text-transform: uppercase; font-size: 80%;">
    Showing <span id="numFound" ng-bind="numFound"></span> of <span ng-bind="totalFound"></span>.
    Sort by
    <select name="sorting" ng-model="sortSetting" ng-change="updateAndSearchAcs()" style="font: inherit; color: inherit; text-transform: inherit; background: transparent;">
      <option value="name_exact asc">Name a-z</option>
      <option value="name_exact desc">Name z-a</option>
      <option value="years_of_experience asc">Years of experience 0-9</option>
      <option value="years_of_experience desc">Years of experience 9-0</option>
      <option value="last_edited desc">Recently edited</option>
      <option value="last_edited asc">Least recently edited</option>
    <select>
  </div>

{% endblock %}

{% block options %}
{% verbatim %}
<div id="optionsbox" ng-class="{hiddenopts: hideFilter}">
    
    <div class="option">
    <h3>View</h3>
    <label><input type="checkbox" id="multicvcheck" ng-model="showListView" ng-change="updateAndSearchAcs()"><i class="icon-th"></i><i class="icon-list"></i></label><br/><br/>

    <a class="butt" href="{{urls.cv_person_add}}" style="margin-bottom:.5em;"><i class="icon-plus-sign"></i> Person</a>
    <a class="butt" style="margin-bottom:.5em;" ng-click="getJson()"><i class="icon-download"></i> Json</a>
  
    </div>
    
    <div class="option animateheight">
      <span class="butt" ng-click="hideFilter=!hideFilter">
        <i id="togglefiltericon" ng-class="{'icon-double-angle-right': hideFilter, 'icon-double-angle-left': !hideFilter}"></i> Filters
      </span>
      <div id="optionsinside">
      <div id="facets">

        <div class="filter">
          <h3>Years of experience</h3>
          <div style="text-align: center;">
            <div ui-slider="yearsOfExperience" ng-model="yearsOfExperienceValue" style="margin:1em 2em"></div>
            <input type="number" ng-model="yearsOfExperienceValue[0]" size="3" min="0" max="{{yearsOfExperienceValue[1]}}" style="width:3em;" ng-change="updateAndSearchAcs()"/>
            <input type="number" ng-model="yearsOfExperienceValue[1]" size="3" min="{{yearsOfExperienceValue[0]}}" max="{{yearsOfExperience.max}}"style="width:3em;" ng-change="updateAndSearchAcs()"/>
          </div>
        </div>

        <div ng-repeat="facetField in facetFields" class="filter">
          <h3>{{facetField.name}}</h3>
          <ul>
            <li ng-repeat="(facetname, facet) in facetField.facets">
              <label>
                <input type="checkbox" ng-model="facet.checked" ng-change="updateAndSearchAcs(facetField, facetname)">
                <span ng-if="facetname!='null'">{{facetname}}</span><span ng-if="facetname=='null'" style="font-style: italic;">No {{facetField.name}}</span> <span ng-if="facet.count>0">({{facet.count}})</span>
              </label>
            </li>
          </ul>
        </div>

        <div class="filter" ng-repeat="cf in customFilter.list">
          <h3>{{cf.title}}</h3>
            <label><input type="radio" name="{{cf.title}}" ng-change="updateAndSearchAcs()" value="all" ng-model="cf.status"/>Show all</label><br/>
            <label><input type="radio" name="{{cf.title}}" ng-change="updateAndSearchAcs()" value="+" ng-model="cf.status"/>Show {{cf.title}}</label><br/>
            <label><input type="radio" name="{{cf.title}}" ng-change="updateAndSearchAcs()" value="-" ng-model="cf.status"/>Show not {{cf.title}}</label><br/>
        </div>

      </div>
      </div>
  </div>

    <div class="option">
      <a class="butt" href="https://wiki.cantara.no/display/ACS/User+Manual" target="_blank">
        <i class="icon-question-sign"></i> Help
      </a>
    </div>

</div>
{% endverbatim %}
{% endblock %}


{% block content %}
    <div ng-show="!showListView">

      {% comment %}
      <div class="block tiled" ng-repeat="p in persons" id="p{{p.id}}">
        <header>
          <h3 ng-bind="p.name"></h3>
          <h4 ng-bind="p.title"></h4>
        </header>
        <img ng-src="{{urls.media}}{{p.image}}" class="photo" style="float: left;" ng-if="p.image">

        <div class="completeness">
          <div class="percent" ng-class="{redpercent: p.completeness.percent < 100}" ng-style="{width: {{p.completeness.percent}}+'%'}"></div>
        </div>

        <section>
          <span style="float: right;">
            <span ng-if="isRecent(p.last_edited)"><i class="icon-time"></i></span>
            <a class="butt" ng-class="{ 'butt-red': p.completeness.percent<100 }"><i class="icon-envelope"></i></a>
          </span>
                  
          <p class="ldetail">{{p.phone}} <img ng-src="{{urls.static}}/img/flags/{{p.country}}.gif" width="16" height="11" alt="p.country" ng-if="p.country"/><br/>
          <a href="mailto:{{p.mail}}" ng-bind="p.mail"></a></p>
        </section>
        <div class="cvset">
          <div class="ldetail" ng-class="{alertbox: p.completeness.percent < 100}">
            <p>Profile {{p.completeness.percent}}% complete. Updated: {{p.last_edited}}</p>
            <p><span ng-if="isRecent(p.last_edited)"><i class="icon-time"></i> More than 4 months since last update.</span></p>
            <ul ng-if="p.completeness.comment">
              <li ng-repeat="c in p.completeness.comment">{{c}}</li>
            </ul>
          </div>
            <a href="{{urls.cv_person_change}}{{p.id}}/" class="butt">Edit person</a>
          <table>
            <tr ng-repeat="cv in p.cv">
              <td>
                <a href="{{urls.cv_detail}}{{cv.id}}/" class="butt bigbutt>">
                  {{cv.tags}}<br/>
                  <span class="dato">{{cv.last_edited}} {{cv.status.percent}}% <span class="completeness"><span class="percent"></span></span></span>
                </a>
              </td>
              <td>
                <a href="{{urls.cv_cv_change}}{{cv.id}}/" class="butt">Edit<br/>
                <span class="dato">CV</span></a>
              </td>
            </tr>
        
            <tr>
              <td><a href="{{urls.cv_add_cv_for_person}}{{p.id}}/" class="butt">Add CV</a></td>
            </tr>
          
          </table>
        </div>
      </div>
      {% endcomment %}

    <script id="persontemplate" type="text/x-dot-template">
      <div class="block tiled" id="p<%=p.id%>">
        <header>
          <h3><%=p.name%></h3>
          <h4><%=p.title%></h4>
        </header>
        <%?p.image%><img src="/media/<%=p.image%>" class="photo" style="float: left;"><%?%>

        <div class="completeness">
          <div class="percent<%? p.completeness.percent < 100 %> redpercent<%?%>" style="width: <%=p.completeness.percent%>%;"></div>
        </div>
        <section>
          <span>                    
                      <a onClick="nagmail.show('<%=p.name%>',<%=p.id%>); return false;" class="butt<%? p.completeness.percent < 100 %> butt-red<%?%>" style="float: right;"><i class="icon-envelope"></i></a>
                    <%? ( new Date().getTime() - new Date(p.last_edited).getTime() ) / (1000*60*60*24) > 120 %><i class="icon-time" style="float: right; margin: .3em"></i><%?%>
                  </span>
                  
          <p class="ldetail"><%=p.phone%> <%? p.country %> <img src="{{ STATIC_URL }}img/flags/<%=p.country%>.gif" width="16" height="11" alt="<%=p.country%>"/><%?%><br/>
          <a href="mailto:<%=p.mail%>"><%=p.mail%></a></p>
        </section>
        <div class="cvset">
          <div class="ldetail<%? p.completeness.percent < 100 %> alertbox<%?%>">
            <p>Profile <%=p.completeness.percent%>% complete. Updated: <%=p.last_edited%></p>
                    <%? ( new Date().getTime() - new Date(p.last_edited).getTime() ) / (1000*60*60*24) > 120 %><i class="icon-time"></i> More than 4 months since last update.<%?%>
            <%? p.completeness.comment %><ul><%~p.completeness.comment :value:index%><li><%=value%></li><%~%></ul><%?%>
          </div>
          <%? p.username == "{{ user.username }}" {% if user.is_superuser %}|| true{% endif %} %>
            <a href="{% url 'admin:cv_person_change' "111000111" %}" class="butt">Edit person</a>
          <%?%>
          <table>
          <%~p.cv :cv:index%>
            <tr>
              <td>
                <a href="{% url 'cv_detail' "888888888" %}" class="butt bigbutt<%? cv.status.percent == 0 %> empty<%?? !cv.is_recent || !cv.status.complete %> red<%?%>" title="<%=cv.status.comment%>">
                  <%=cv.tags%><br/>
                  <span class="dato">
                    <%=cv.last_edited%> <%=cv.status.percent%>%
                    <span class="completeness">
                      <span class="percent<%? cv.status.percent < 100 %> redpercent<%?%>" style="width: <%=cv.status.percent%>%;"></span>
                    </span>
                  </span>
                </a>
              </td>
              {% if user.is_authenticated %}
                <%? p.username == "{{ user.username }}" {% if user.is_superuser %}|| true{% endif %} %>
                  <td><a href="{% url 'admin:cv_cv_change' "888888888" %}" class="butt">Edit<br/>
                  <span class="dato">CV</span></a></td>
                <%?%>
              {% endif %}
            </tr>
          <%~%>
          {% if user.is_authenticated %}
            <%? p.username == "{{ user.username }}" {% if user.is_superuser %}|| true{% endif %} %>
              <tr>
                <td><a href="{% url 'cv_add_cv_for_person' "111000111" %}" class="butt">Add CV</a></td>
              </tr>
            <%?%>
          {% endif %}
          </table>
        </div>
      </div>
    </script> 

      <div id="cardresults"></div>

      {% verbatim %}
      <div class="block tiled" ng-if="isLoading">
        <header>
          <h3>Loading...</h3>
        </header>
        <img ng-src="{{urls.static}}/img/loading.gif" class="photo" style="float: left;">
      </div>
      {% endverbatim %}

    </div>

    <div ng-show="showListView">

    <form name="multicv" action="{% url 'cv_multi' %}" method="get">
      <table id="multiresults" class="responsivetable">
        <thead>
          <tr>
            <th colspan="3" class="lineright">Persons</th>
            <th colspan="2">CVs</th>
          </tr>
          <tr>
            <td>
              <input tri-state-checkbox elements="persons" elements-selected="personsSelected" change-action="updateSelectedEmails()">
              </td>
            <td colspan="2" class="lineright">
              <button class="butt" data-clipboard-target="selectedemails" id="emailCopyButton" ng-if="hasFlash" type="button">
                <i class="icon-copy"></i> Copy e-mails
              </button>
              <button class="butt" ng-click="showSelectedEmails()" ng-if="!hasFlash" type="button">
                <i class="icon-copy"></i> <span ng-hide="selectedEmailsVisible">Show</span><span ng-show="selectedEmailsVisible">Hide</span> e-mails
              </button>
              <div ng-show="selectedEmailsVisible">
                Press CTRL+C to copy.<br>
                <textarea cols="30" rows="10" disabled="disabled" ng-model="selectedEmails" id="selectedemails"></textarea>
              </div>
              </td>
            <td>

              <button class="butt" ng-click="downloadMulti()" type="button"><i class="icon-copy"></i> Download CVs</button>
              <button type="button" class="menutoggle" style="background: none; cursor: pointer; border-bottom: 1px dotted #aaa; text-align: left">
                {% verbatim %} {{multi.format}}, {{multi.language}}, {{multi.template}} {% endverbatim %}
                <i class="icon-caret-down"></i>
              </button>
              {% verbatim %}
              <div class="menulist menulisthidden">
                <div ng-repeat="(pName, param) in multi.params">
                  <h3 style="text-transform: capitalize">{{pName}}</h3>
                  <label ng-repeat="p in param" ng-click="multi.update(pName, p.label)"><input type="radio" name="{{pName}}" value="{{p.value}}" ng-checked="{{p.checked}}"> {{p.label}}<br></label>
                </div>
              </div>
              {% endverbatim %}

            </td>
            <td>Download</td>
          </tr>
        </thead>
      {% comment %}
        {% verbatim %}
          <tbody ng-repeat="p in persons">
            <tr ng-repeat="cv in p.cv">
              <td rowspan="p.cv.length" ng-if="$index==0">
                <input type="checkbox" ng-model="p.isSelected" value="p.mail" id="p{{$index}}" ng-change="updateSelectedEmails()"/>
                </td>
              <td rowspan="p.cv.length" ng-if="$index==0">
                <img ng-src="{{urls.static}}/img/flags/{{p.country}}.gif" width="16" height="11" alt="p.country" ng-if="p.country"/>
                </td>
              <td rowspan="p.cv.length" ng-if="$index==0" class="lineright">
                <label for="p{{$index}}">
                <h3>{{p.name}} ‒ {{p.title}}</h3>
                <p><small>Profile {{p.completeness.percent}}% complete. Updated: {{p.last_edited}}</small></p>
                </label>
                </td>
              <td ng-if="$index>0"></td>
              <td ng-if="$index>0"></td>
              <td ng-if="$index>0"></td>
              <td data-title="Select CV">
                <label><input type="checkbox" name="cvid" value="{{cv.id}}" >{{cv.tags}} ({{cv.status.percent}}%)</label>
                </td>
              <td data-title="Download">
                <a href="{{urls.cv_detail}}{{cv.id}}/" title="{{cv.status.comment}}" target="_blank" class="butt">View</a>&nbsp;
                <a href="{{urls.cv_download_format_doc}}?cvid={{cv.id}}" target="_blank" class="butt">DOC</a>&nbsp;
                <a href="{{urls.cv_download_format_pdf}}?cvid={{cv.id}}" target="_blank" class="butt">PDF</a>
                </td>
            </tr>
            <tr ng-if="!p.cv.length">
              <td>
                <input type="checkbox" ng-model="p.isSelected" value="p.mail" id="p{{$index}}" ng-change="updateSelectedEmails()"/>
                </td>
              <td>
                <img ng-src="{{urls.static}}/img/flags/{{p.country}}.gif" width="16" height="11" alt="p.country" ng-if="p.country"/>
                </td>
              <td class="lineright">
                <label for="p{{$index}}">
                <h3>{{p.name}} ‒ {{p.title}}</h3>
                <p><small>Profile {{p.completeness.percent}}% complete. Updated: {{p.last_edited}}</small></p>
                </label>
                </td>
              <td></td>
              <td></td>
            </tr>
          </tbody>

          </tr>
          <tr>
            <td colspan="4" ng-if="!persons.length && searchQuery">No results for search "{{searchQuery}}".</td>
            <td colspan="4" ng-if="!persons.length && !searchQuery">Type above to start searching!</td>
          </tr>
        {% endverbatim %}
      {% endcomment %}
      </table>
    <form>

    <script id="tabletemplate" type="text/x-dot-template">
      <% if (p.cv.length < 1) { p.cv.push({}); var nocvs = true; } %>
      <tbody>
      <%~p.cv :cv:index%>
        <tr id="p<%=p.id%>">
          <%? !personwritten %>
            <td rowspan="<%=p.cv.length%>">
              <input type="checkbox" ng-model="persons[<%=p.index%>].isSelected" value="<%=p.mail%>" id="p<%=p.index%>checkbox" ng-change="updateSelectedEmails()"/>
              </td>
            <td rowspan="<%=p.cv.length%>">
              <%? p.country %><img src="{{ STATIC_URL }}/img/flags/<%=p.country%>.gif" width="16" height="11" alt="<%=p.country%>"/><%?%>
              <span style="display: inline-block; width:24px; height: 24px; background-size: cover; <%?p.image%>background-image: url({{ MEDIA_URL }}/<%=p.image%>); <%?%>"></span>
              </td>
            <td rowspan="<%=p.cv.length%>" class="lineright">
              <label for="p<%=p.index%>checkbox" class="textcheckbox">
              <h3><%=p.name%> ‒ <%=p.title%></h3>
              <p><small>Profile <%=p.completeness.percent%>% complete. Updated: <%=p.last_edited%></small></p>
              </label>
              </td>
            <% var personwritten = true; %>
          <%?%>
          <%? !nocvs %>
          <td data-title="Select CV">
            <label for="<%=cv.id%>"><input type="checkbox" name="cvid" value="<%=cv.id%>" id="<%=cv.id%>" ><%=cv.tags%> (<%=cv.status.percent%>%)</label>
            </td>
          <td data-title="Download">
            <a href="{% url 'cv_detail' "999888999" %}" title="<%=cv.status.comment%>" target="_blank" class="butt">View</a>&nbsp;
            <a href="{% url 'cv_download_format' 'doc' %}?cvid=<%=cv.id%>" target="_blank" class="butt">DOC</a>&nbsp;
            <a href="{% url 'cv_download_format' 'pdf' %}?cvid=<%=cv.id%>" target="_blank" class="butt">PDF</a>
            </td>
          <%??%>
            <td></td>
            <td></td>
          <%?%>
        </tr>
      <%~%>
      </tbody>
    </script> 

    </div>

{% endblock %}